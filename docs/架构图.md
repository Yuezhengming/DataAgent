# Spring AI Alibaba DataAgent 架构图

本文档包含 DataAgent 项目的各类架构图和流程图。

---

## 1. 系统整体架构图

```mermaid
graph TB
    subgraph "前端层"
        A[Vue 3 前端应用]
        A1[智能体管理]
        A2[对话交互]
        A3[数据源配置]
        A --> A1
        A --> A2
        A --> A3
    end
    
    subgraph "应用层 - Management Module"
        B[Spring Boot Web 应用]
        B1[AgentController]
        B2[ChatController]
        B3[GraphController]
        B4[DatasourceController]
        B --> B1
        B --> B2
        B --> B3
        B --> B4
    end
    
    subgraph "核心引擎层 - Chat Module"
        C[Graph 工作流引擎]
        C1[GraphServiceImpl]
        C2[15个节点实现]
        C3[路由器 Dispatchers]
        C4[向量检索服务]
        C --> C1
        C --> C2
        C --> C3
        C --> C4
    end
    
    subgraph "数据层"
        D1[(MySQL<br/>业务数据)]
        D2[(VectorStore<br/>Schema索引)]
        D3[(业务数据源<br/>多数据源)]
    end
    
    subgraph "AI 服务层"
        E1[阿里云 DashScope]
        E2[ChatModel<br/>qwen-plus]
        E3[EmbeddingModel<br/>text-embedding-v4]
        E1 --> E2
        E1 --> E3
    end
    
    A -->|HTTP/SSE| B
    B -->|调用| C
    C -->|读写| D1
    C -->|向量检索| D2
    C -->|查询| D3
    C -->|LLM调用| E2
    C -->|文本嵌入| E3
    
    style A fill:#e1f5ff
    style B fill:#fff3e0
    style C fill:#f3e5f5
    style D1 fill:#e8f5e9
    style D2 fill:#e8f5e9
    style D3 fill:#e8f5e9
    style E1 fill:#fff9c4
```

---

## 2. Graph 工作流完整流程图

```mermaid
graph TD
    START([开始]) --> QueryRewrite[1. 查询重写节点<br/>QueryRewriteNode]
    
    QueryRewrite -->|数据分析需求| KeywordExtract[2. 关键词提取节点<br/>KeywordExtractNode]
    QueryRewrite -->|非数据分析| END1([结束])
    
    KeywordExtract --> SchemaRecall[3. Schema召回节点<br/>SchemaRecallNode]
    SchemaRecall --> TableRelation[4. 表关系节点<br/>TableRelationNode]
    
    TableRelation -->|成功| Planner[5. 规划节点<br/>PlannerNode]
    TableRelation -->|失败重试| TableRelation
    TableRelation -->|超过重试| END2([结束])
    
    Planner --> PlanExecutor[6. 计划执行器<br/>PlanExecutorNode]
    
    PlanExecutor -->|验证失败| Planner
    PlanExecutor -->|需要人工审核| HumanFeedback[14. 人工反馈节点<br/>HumanFeedbackNode]
    PlanExecutor -->|执行SQL| SqlExecute[8. SQL执行节点<br/>SqlExecuteNode]
    PlanExecutor -->|执行Python| PythonGenerate[10. Python生成节点<br/>PythonGenerateNode]
    PlanExecutor -->|完成| ReportGenerator[13. 报告生成节点<br/>ReportGeneratorNode]
    
    HumanFeedback -->|拒绝| Planner
    HumanFeedback -->|通过| PlanExecutor
    
    SqlExecute -->|成功| SemanticCheck[9. 语义一致性检查<br/>SemanticConsistencyNode]
    SqlExecute -->|失败| SqlGenerate[7. SQL生成节点<br/>SqlGenerateNode]
    
    SqlGenerate -->|缺少Schema| KeywordExtract
    SqlGenerate -->|生成成功| SqlExecute
    
    SemanticCheck -->|通过| PlanExecutor
    SemanticCheck -->|不通过| SqlGenerate
    
    PythonGenerate --> PythonExecute[11. Python执行节点<br/>PythonExecuteNode]
    PythonExecute -->|成功| PythonAnalyze[12. Python分析节点<br/>PythonAnalyzeNode]
    PythonExecute -->|失败重试| PythonGenerate
    PythonExecute -->|超过重试| END3([结束])
    
    PythonAnalyze --> PlanExecutor
    
    ReportGenerator --> END4([结束])
    
    style START fill:#4caf50,color:#fff
    style END1 fill:#f44336,color:#fff
    style END2 fill:#f44336,color:#fff
    style END3 fill:#f44336,color:#fff
    style END4 fill:#4caf50,color:#fff
    style Planner fill:#2196f3,color:#fff
    style PlanExecutor fill:#ff9800,color:#fff
    style HumanFeedback fill:#9c27b0,color:#fff
```

---

## 3. NL2SQL 核心流程时序图

```mermaid
sequenceDiagram
    participant User as 用户
    participant Frontend as 前端
    participant GraphAPI as GraphController
    participant GraphEngine as Graph引擎
    participant LLM as 大模型
    participant VectorDB as 向量库
    participant BizDB as 业务数据库
    
    User->>Frontend: 输入自然语言查询
    Frontend->>GraphAPI: POST /api/graph/stream
    GraphAPI->>GraphEngine: 启动工作流
    
    GraphEngine->>LLM: 1. 查询重写
    LLM-->>GraphEngine: 重写后的查询
    GraphEngine-->>Frontend: SSE: 重写完成
    
    GraphEngine->>LLM: 2. 提取关键词
    LLM-->>GraphEngine: 关键词列表
    GraphEngine-->>Frontend: SSE: 关键词提取完成
    
    GraphEngine->>VectorDB: 3. 向量检索Schema
    VectorDB-->>GraphEngine: 相关表和字段
    GraphEngine-->>Frontend: SSE: Schema召回完成
    
    GraphEngine->>LLM: 4. 分析表关系
    LLM-->>GraphEngine: 表关系JSON
    GraphEngine-->>Frontend: SSE: 表关系分析完成
    
    GraphEngine->>LLM: 5. 生成执行计划
    LLM-->>GraphEngine: 执行计划JSON
    GraphEngine-->>Frontend: SSE: 计划生成完成
    
    alt 需要人工审核
        GraphEngine-->>Frontend: SSE: 等待人工审核
        Frontend->>User: 显示审核界面
        User->>Frontend: 提交反馈
        Frontend->>GraphAPI: POST /api/graph/feedback
        GraphAPI->>GraphEngine: 恢复执行
    end
    
    GraphEngine->>LLM: 6. 生成SQL
    LLM-->>GraphEngine: SQL语句
    GraphEngine-->>Frontend: SSE: SQL生成完成
    
    GraphEngine->>BizDB: 7. 执行SQL
    BizDB-->>GraphEngine: 查询结果
    GraphEngine-->>Frontend: SSE: SQL执行完成
    
    GraphEngine->>LLM: 8. 语义一致性检查
    LLM-->>GraphEngine: 检查结果
    
    alt 需要数据分析
        GraphEngine->>LLM: 9. 生成Python代码
        LLM-->>GraphEngine: Python代码
        GraphEngine->>GraphEngine: 10. 执行Python
        GraphEngine-->>Frontend: SSE: 分析完成
    end
    
    GraphEngine->>LLM: 11. 生成报告
    LLM-->>GraphEngine: Markdown报告
    GraphEngine-->>Frontend: SSE: 报告生成完成
    
    Frontend->>User: 展示最终结果
```

---

## 4. 数据库 ER 图

```mermaid
erDiagram
    AGENT ||--o{ AGENT_DATASOURCE : "绑定"
    DATASOURCE ||--o{ AGENT_DATASOURCE : "被绑定"
    AGENT ||--o{ CHAT_SESSION : "拥有"
    CHAT_SESSION ||--o{ CHAT_MESSAGE : "包含"
    AGENT ||--o{ BUSINESS_KNOWLEDGE : "关联"
    AGENT ||--o{ SEMANTIC_MODEL : "关联"
    AGENT ||--o{ AGENT_PRESET_QUESTION : "拥有"
    AGENT ||--o{ AGENT_KNOWLEDGE : "拥有"
    
    AGENT {
        int id PK
        string name
        string description
        string avatar
        string status
        text prompt
        string category
        bigint admin_id
        string tags
        tinyint human_review_enabled
        timestamp create_time
        timestamp update_time
    }
    
    DATASOURCE {
        int id PK
        string name
        string type
        string host
        int port
        string database_name
        string username
        string password
        string status
        timestamp create_time
        timestamp update_time
    }
    
    AGENT_DATASOURCE {
        int id PK
        int agent_id FK
        int datasource_id FK
        tinyint is_active
        timestamp create_time
    }
    
    CHAT_SESSION {
        string id PK
        int agent_id FK
        string title
        string status
        tinyint is_pinned
        bigint user_id
        timestamp create_time
        timestamp update_time
    }
    
    CHAT_MESSAGE {
        bigint id PK
        string session_id FK
        string role
        text content
        string message_type
        text metadata
        timestamp create_time
    }
    
    BUSINESS_KNOWLEDGE {
        bigint id PK
        string business_term
        text description
        text synonyms
        tinyint is_recall
        bigint agent_id FK
        timestamp create_time
        timestamp update_time
    }
    
    SEMANTIC_MODEL {
        bigint id PK
        bigint agent_id FK
        string field_name
        text synonyms
        string origin_name
        text description
        string type
        tinyint is_recall
        tinyint status
        timestamp created_time
        timestamp updated_time
    }
    
    AGENT_PRESET_QUESTION {
        bigint id PK
        int agent_id FK
        text question
        int sort_order
        tinyint is_active
        timestamp create_time
        timestamp update_time
    }
    
    AGENT_KNOWLEDGE {
        int id PK
        int agent_id FK
        string title
        text content
        string type
        timestamp create_time
        timestamp update_time
    }
```

---

## 5. 模块依赖关系图

```mermaid
graph LR
    A[spring-ai-alibaba-data-agent-management<br/>Web应用层] --> B[spring-ai-alibaba-data-agent-chat<br/>核心引擎层]
    B --> C[spring-ai-alibaba-data-agent-common<br/>公共组件层]
    
    A --> D[Spring Boot 3.4.8]
    A --> E[Spring MVC]
    A --> F[MyBatis 3.0.4]
    
    B --> G[Spring AI 1.0.1]
    B --> H[Spring AI Alibaba 1.0.0.4]
    B --> I[Graph Engine]
    
    C --> J[Common Utils]
    C --> K[Common DTOs]
    
    style A fill:#e1f5ff
    style B fill:#fff3e0
    style C fill:#f3e5f5
```

---

## 6. Graph 节点状态流转图

```mermaid
stateDiagram-v2
    [*] --> QueryRewrite: 开始执行
    
    QueryRewrite --> KeywordExtract: 数据分析需求
    QueryRewrite --> [*]: 非数据分析
    
    KeywordExtract --> SchemaRecall
    SchemaRecall --> TableRelation
    
    TableRelation --> Planner: 成功
    TableRelation --> TableRelation: 重试
    TableRelation --> [*]: 失败
    
    Planner --> PlanExecutor
    
    PlanExecutor --> HumanFeedback: 需要审核
    PlanExecutor --> SqlExecute: 执行SQL
    PlanExecutor --> PythonGenerate: 执行Python
    PlanExecutor --> ReportGenerator: 完成
    PlanExecutor --> Planner: 验证失败
    
    HumanFeedback --> Planner: 拒绝
    HumanFeedback --> PlanExecutor: 通过
    
    SqlExecute --> SqlGenerate: 失败
    SqlExecute --> SemanticCheck: 成功
    
    SqlGenerate --> KeywordExtract: 缺少Schema
    SqlGenerate --> SqlExecute: 生成成功
    
    SemanticCheck --> PlanExecutor: 通过
    SemanticCheck --> SqlGenerate: 不通过
    
    PythonGenerate --> PythonExecute
    PythonExecute --> PythonAnalyze: 成功
    PythonExecute --> PythonGenerate: 重试
    PythonExecute --> [*]: 失败
    
    PythonAnalyze --> PlanExecutor
    
    ReportGenerator --> [*]: 完成
```

---

## 7. 前端页面路由图

```mermaid
graph TD
    A[/] --> B[/agents<br/>智能体列表]
    B --> C[/agents/create<br/>创建智能体]
    B --> D[/agents/:id<br/>智能体详情]
    D --> E[/agents/:id/run<br/>对话交互]
    
    style B fill:#e1f5ff
    style C fill:#fff3e0
    style D fill:#f3e5f5
    style E fill:#e8f5e9
```

---

**文档版本**: v1.0  
**最后更新**: 2025-11-06

