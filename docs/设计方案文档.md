# Spring AI Alibaba DataAgent 设计方案文档

**版本**: v1.0  
**日期**: 2025-11-06  
**作者**: DataAgent 团队

---

## 📋 目录

- [1. 项目概述](#1-项目概述)
- [2. 系统架构设计](#2-系统架构设计)
- [3. 核心技术选型](#3-核心技术选型)
- [4. 模块设计](#4-模块设计)
- [5. Graph 工作流引擎](#5-graph-工作流引擎)
- [6. 数据库设计](#6-数据库设计)
- [7. API 接口设计](#7-api-接口设计)
- [8. 前端架构设计](#8-前端架构设计)
- [9. 安全性设计](#9-安全性设计)
- [10. 部署方案](#10-部署方案)
- [11. 扩展性设计](#11-扩展性设计)

---

## 1. 项目概述

### 1.1 项目背景

Spring AI Alibaba DataAgent 是一个基于 Spring AI Alibaba 框架的智能数据分析平台，旨在通过自然语言处理技术，将用户的自然语言查询转换为 SQL 查询（NL2SQL），并提供数据分析、可视化和报告生成能力。

### 1.2 核心价值

- **降低数据分析门槛**：非技术人员可通过自然语言查询数据
- **提升分析效率**：自动化 SQL 生成和数据分析流程
- **智能化决策支持**：AI 驱动的数据洞察和报告生成
- **多租户支持**：支持多个智能体（Agent）独立配置和管理

### 1.3 核心功能

| 功能模块 | 描述 |
|---------|------|
| **NL2SQL 引擎** | 自然语言转 SQL，支持复杂查询和多表关联 |
| **智能体管理** | 多智能体配置、数据源绑定、知识库管理 |
| **Graph 工作流** | 基于有向图的任务编排引擎，支持动态路由和错误重试 |
| **人工审核** | 关键步骤支持人工介入和反馈 |
| **数据分析** | Python 代码生成和执行，支持数据可视化 |
| **会话管理** | 多轮对话、会话历史、上下文保持 |
| **知识增强** | 业务知识库、语义模型、预设问题 |

---

## 2. 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Frontend)                      │
│  Vue 3 + Element Plus + Vite                                │
│  - Agent 管理界面  - 数据源配置  - 对话交互  - 可视化展示    │
└─────────────────────────────────────────────────────────────┘
                              ↓ HTTP/SSE
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Management Module)                 │
│  Spring Boot 3.4.8 + Spring MVC                             │
│  - REST API  - 会话管理  - 权限控制  - 文件上传             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    核心引擎层 (Chat Module)                   │
│  Spring AI Alibaba 1.0.0.4                                  │
│  - Graph 工作流引擎  - NL2SQL 核心逻辑  - 向量检索          │
│  - Python 代码执行  - 语义一致性校验                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        数据层 (Data Layer)                    │
│  - MySQL (业务数据)  - 向量数据库 (Schema 索引)              │
│  - 业务数据源 (多数据源支持)                                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      AI 服务层 (AI Services)                  │
│  - 阿里云 DashScope (通义千问)                               │
│  - ChatModel (qwen-plus)  - EmbeddingModel (text-embedding-v4) │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 分层职责

| 层级 | 职责 | 技术栈 |
|-----|------|--------|
| **前端层** | 用户交互、数据展示、状态管理 | Vue 3, Element Plus, Axios |
| **应用层** | API 网关、业务编排、权限控制 | Spring Boot, Spring MVC |
| **核心引擎层** | NL2SQL 逻辑、工作流编排、AI 调用 | Spring AI, Graph Engine |
| **数据层** | 数据持久化、向量检索、多数据源管理 | MySQL, MyBatis, VectorStore |
| **AI 服务层** | 大模型推理、文本嵌入 | DashScope API |

### 2.3 模块依赖关系

```
spring-ai-alibaba-data-agent-management (Web 应用)
    ↓ depends on
spring-ai-alibaba-data-agent-chat (核心引擎)
    ↓ depends on
spring-ai-alibaba-data-agent-common (公共组件)
```

---

## 3. 核心技术选型

### 3.1 后端技术栈

| 技术 | 版本 | 用途 |
|-----|------|------|
| **Java** | 17 | 编程语言 |
| **Spring Boot** | 3.4.8 | 应用框架 |
| **Spring AI** | 1.0.1 | AI 集成框架 |
| **Spring AI Alibaba** | 1.0.0.4 | 阿里云 AI 集成 |
| **MyBatis** | 3.0.4 | ORM 框架 |
| **MySQL** | 8.0+ | 关系型数据库 |
| **Druid** | - | 数据库连接池 |
| **Lombok** | - | 代码简化 |
| **Jackson** | - | JSON 序列化 |

### 3.2 前端技术栈

| 技术 | 版本 | 用途 |
|-----|------|------|
| **Vue** | 3.x | 前端框架 |
| **Vite** | - | 构建工具 |
| **Element Plus** | - | UI 组件库 |
| **Axios** | - | HTTP 客户端 |
| **Vue Router** | - | 路由管理 |

### 3.3 AI 能力

| 能力 | 提供方 | 模型 |
|-----|--------|------|
| **对话生成** | 阿里云 DashScope | qwen-plus |
| **文本嵌入** | 阿里云 DashScope | text-embedding-v4 |
| **向量检索** | SimpleVectorStore / Milvus | - |

---

## 4. 模块设计

### 4.1 模块划分

#### 4.1.1 spring-ai-alibaba-data-agent-management

**职责**: Web 应用层，提供 REST API 和业务管理功能

**核心包结构**:
```
com.alibaba.cloud.ai
├── controller/          # REST 控制器
│   ├── AgentController              # 智能体管理
│   ├── ChatController               # 会话管理
│   ├── GraphController              # Graph 工作流交互
│   ├── DatasourceController         # 数据源管理
│   ├── AgentDatasourceController    # 智能体数据源绑定
│   ├── BusinessKnowledgeController  # 业务知识管理
│   ├── SemanticModelController      # 语义模型管理
│   └── FileUploadController         # 文件上传
├── service/            # 业务服务层
├── entity/             # 实体类
├── mapper/             # MyBatis Mapper
├── dto/                # 数据传输对象
└── config/             # 配置类
```

**关键功能**:
- Agent CRUD 操作
- 数据源配置和绑定
- 会话和消息管理
- 业务知识库管理
- 文件上传（头像、文档）

#### 4.1.2 spring-ai-alibaba-data-agent-chat

**职责**: 核心引擎层，实现 NL2SQL 和 Graph 工作流

**核心包结构**:
```
com.alibaba.cloud.ai
├── config/             # 配置类
│   └── DataAgentConfiguration       # Graph 工作流配置
├── service/            # 核心服务
│   ├── graph/
│   │   └── GraphServiceImpl         # Graph 执行服务
│   ├── schema/
│   │   └── SchemaService            # Schema 管理
│   ├── query/
│   │   └── QueryProcessingService   # 查询处理
│   └── vectorstore/
│       └── AgentVectorStoreService  # 向量库服务
├── node/               # Graph 节点实现
│   ├── QueryRewriteNode             # 查询重写
│   ├── KeywordExtractNode           # 关键词提取
│   ├── SchemaRecallNode             # Schema 召回
│   ├── TableRelationNode            # 表关系分析
│   ├── PlannerNode                  # 计划生成
│   ├── PlanExecutorNode             # 计划执行
│   ├── SqlGenerateNode              # SQL 生成
│   ├── SqlExecuteNode               # SQL 执行
│   ├── PythonGenerateNode           # Python 生成
│   ├── PythonExecuteNode            # Python 执行
│   ├── ReportGeneratorNode          # 报告生成
│   └── HumanFeedbackNode            # 人工反馈
├── dispatcher/         # 路由器实现
│   ├── QueryRewriteDispatcher
│   ├── PlanExecutorDispatcher
│   ├── SqlGenerateDispatcher
│   └── ...
├── pojo/               # 数据对象
│   ├── Plan                         # 执行计划
│   ├── ExecutionStep                # 执行步骤
│   └── KeywordExtractionResult      # 关键词提取结果
└── util/               # 工具类
    ├── StateUtil                    # 状态工具
    ├── FluxUtil                     # 流式处理工具
    └── NodeBeanUtil                 # 节点管理工具
```

**关键功能**:
- Graph 工作流编排和执行
- NL2SQL 核心逻辑
- 向量检索和 Schema 召回
- Python 代码生成和执行
- 语义一致性校验

#### 4.1.3 spring-ai-alibaba-data-agent-frontend

**职责**: 前端界面，提供用户交互

**核心目录结构**:
```
src/
├── views/              # 页面组件
│   ├── AgentList.vue               # 智能体列表
│   ├── AgentCreate.vue             # 创建智能体
│   ├── AgentDetail.vue             # 智能体详情
│   └── AgentRun.vue                # 对话交互
├── components/         # 通用组件
│   ├── agent/                      # Agent 相关组件
│   └── run/                        # 运行时组件
├── services/           # API 服务
│   ├── agent.ts
│   ├── chat.ts
│   ├── graph.ts
│   ├── datasource.ts
│   └── businessKnowledge.ts
├── router/             # 路由配置
├── layouts/            # 布局组件
└── styles/             # 样式文件
```

---

## 5. Graph 工作流引擎

### 5.1 设计理念

Graph 工作流引擎是 DataAgent 的核心，采用**有向图**模型编排复杂的 NL2SQL 流程。

**核心特性**:
- ✅ **声明式定义**: 通过 API 定义节点和边
- ✅ **动态路由**: 根据状态条件选择下一个节点
- ✅ **状态管理**: 全局状态在节点间传递
- ✅ **流式输出**: 实时反馈节点执行进度
- ✅ **错误重试**: 自动重试和人工介入
- ✅ **断点续传**: 支持暂停和恢复执行

### 5.2 核心组件

| 组件 | 接口/类 | 职责 |
|-----|---------|------|
| **状态图** | `StateGraph` | 定义工作流结构（节点+边） |
| **编译图** | `CompiledGraph` | 可执行的工作流实例 |
| **全局状态** | `OverAllState` | 节点间共享的数据容器 |
| **节点动作** | `NodeAction` | 节点业务逻辑接口 |
| **边动作** | `EdgeAction` | 路由决策逻辑接口 |
| **运行配置** | `RunnableConfig` | 执行参数（threadId 等） |

### 5.3 工作流定义

完整的 NL2SQL 工作流包含 **15 个节点** 和 **多条条件边**：

**节点列表**:
1. `QueryRewriteNode` - 查询重写和意图识别
2. `KeywordExtractNode` - 关键词和实体提取
3. `SchemaRecallNode` - 从向量库召回相关 Schema
4. `TableRelationNode` - 分析表关系和构建 Schema
5. `PlannerNode` - 生成执行计划（JSON 格式）
6. `PlanExecutorNode` - 验证和执行计划
7. `SqlGenerateNode` - 生成 SQL 查询
8. `SqlExecuteNode` - 执行 SQL 并获取结果
9. `SemanticConsistencyNode` - 语义一致性校验
10. `PythonGenerateNode` - 生成 Python 分析代码
11. `PythonExecuteNode` - 执行 Python 代码
12. `PythonAnalyzeNode` - 分析 Python 执行结果
13. `ReportGeneratorNode` - 生成最终报告
14. `HumanFeedbackNode` - 人工审核和反馈
15. `END` - 结束节点

**关键路径**:
```
START → QueryRewrite → KeywordExtract → SchemaRecall → TableRelation 
  → Planner → PlanExecutor → [SqlExecute | PythonGenerate | ReportGenerator]
  → END
```

### 5.4 节点实现规范

所有节点实现 `NodeAction` 接口：

```java
public interface NodeAction {
    Map<String, Object> apply(OverAllState state) throws Exception;
}
```

**实现要点**:
- 从 `state` 读取输入数据
- 执行业务逻辑（调用 LLM、数据库等）
- 返回 `Map` 更新状态
- 支持流式输出（通过 `Flux<GraphResponse<StreamingOutput>>`）

### 5.5 路由器实现规范

所有路由器实现 `EdgeAction` 接口：

```java
public interface EdgeAction {
    String apply(OverAllState state) throws Exception;
}
```

**实现要点**:
- 从 `state` 读取判断依据
- 根据业务规则返回下一个节点名称
- 支持循环重试（返回当前节点）
- 支持提前结束（返回 `END`）

---

## 6. 数据库设计

### 6.1 核心表结构

#### 6.1.1 agent (智能体表)

存储智能体的基本信息和配置。

| 字段 | 类型 | 说明 |
|-----|------|------|
| `id` | INT | 主键，自增 |
| `name` | VARCHAR(255) | 智能体名称 |
| `description` | TEXT | 智能体描述 |
| `avatar` | TEXT | 头像 URL |
| `status` | VARCHAR(50) | 状态：draft/published/offline |
| `prompt` | TEXT | 自定义 Prompt 配置 |
| `category` | VARCHAR(100) | 分类 |
| `admin_id` | BIGINT | 管理员 ID |
| `tags` | TEXT | 标签（逗号分隔） |
| `human_review_enabled` | TINYINT | 是否启用人工审核（0/1） |
| `create_time` | TIMESTAMP | 创建时间 |
| `update_time` | TIMESTAMP | 更新时间 |

**索引**:
- `idx_name` - 按名称查询
- `idx_status` - 按状态筛选
- `idx_category` - 按分类筛选

#### 6.1.2 datasource (数据源表)

存储业务数据源的连接信息。

| 字段 | 类型 | 说明 |
|-----|------|------|
| `id` | INT | 主键，自增 |
| `name` | VARCHAR(255) | 数据源名称 |
| `type` | VARCHAR(50) | 类型：mysql/postgresql/clickhouse |
| `host` | VARCHAR(255) | 主机地址 |
| `port` | INT | 端口号 |
| `database_name` | VARCHAR(255) | 数据库名 |
| `username` | VARCHAR(255) | 用户名 |
| `password` | VARCHAR(255) | 密码（加密存储） |
| `status` | VARCHAR(50) | 状态：active/inactive |
| `create_time` | TIMESTAMP | 创建时间 |
| `update_time` | TIMESTAMP | 更新时间 |

#### 6.1.3 agent_datasource (智能体数据源关联表)

多对多关系，一个智能体可以绑定多个数据源。

| 字段 | 类型 | 说明 |
|-----|------|------|
| `id` | INT | 主键，自增 |
| `agent_id` | INT | 智能体 ID |
| `datasource_id` | INT | 数据源 ID |
| `is_active` | TINYINT | 是否激活（0/1） |
| `create_time` | TIMESTAMP | 创建时间 |

**唯一索引**: `(agent_id, datasource_id)`

#### 6.1.4 chat_session (会话表)

存储用户与智能体的对话会话。

| 字段 | 类型 | 说明 |
|-----|------|------|
| `id` | VARCHAR(36) | 主键，UUID |
| `agent_id` | INT | 智能体 ID |
| `title` | VARCHAR(255) | 会话标题 |
| `status` | VARCHAR(50) | 状态：active/archived/deleted |
| `is_pinned` | TINYINT | 是否置顶（0/1） |
| `user_id` | BIGINT | 用户 ID |
| `create_time` | TIMESTAMP | 创建时间 |
| `update_time` | TIMESTAMP | 更新时间 |

**索引**:
- `idx_agent_id` - 按智能体查询
- `idx_user_id` - 按用户查询

#### 6.1.5 chat_message (消息表)

存储会话中的消息记录。

| 字段 | 类型 | 说明 |
|-----|------|------|
| `id` | BIGINT | 主键，自增 |
| `session_id` | VARCHAR(36) | 会话 ID |
| `role` | VARCHAR(50) | 角色：user/assistant/system |
| `content` | TEXT | 消息内容 |
| `message_type` | VARCHAR(50) | 类型：text/sql/result/error |
| `metadata` | TEXT | 元数据（JSON 格式） |
| `create_time` | TIMESTAMP | 创建时间 |

**索引**:
- `idx_session_id` - 按会话查询

#### 6.1.6 business_knowledge (业务知识表)

存储业务术语和知识，用于增强 NL2SQL 理解能力。

| 字段 | 类型 | 说明 |
|-----|------|------|
| `id` | BIGINT | 主键，自增 |
| `business_term` | VARCHAR(255) | 业务术语 |
| `description` | TEXT | 描述 |
| `synonyms` | TEXT | 同义词（逗号分隔） |
| `is_recall` | TINYINT | 是否参与召回（0/1） |
| `agent_id` | BIGINT | 关联智能体 ID |
| `create_time` | TIMESTAMP | 创建时间 |
| `update_time` | TIMESTAMP | 更新时间 |

#### 6.1.7 semantic_model (语义模型表)

存储字段的语义映射和同义词配置。

| 字段 | 类型 | 说明 |
|-----|------|------|
| `id` | BIGINT | 主键，自增 |
| `agent_id` | BIGINT | 关联智能体 ID |
| `field_name` | VARCHAR(255) | 字段名称 |
| `synonyms` | TEXT | 同义词 |
| `origin_name` | VARCHAR(255) | 原始字段名 |
| `description` | TEXT | 字段描述 |
| `type` | VARCHAR(255) | 字段类型 |
| `is_recall` | TINYINT | 是否参与召回（0/1） |
| `status` | TINYINT | 状态（0/1） |
| `created_time` | TIMESTAMP | 创建时间 |
| `updated_time` | TIMESTAMP | 更新时间 |

#### 6.1.8 agent_preset_question (预设问题表)

存储智能体的预设问题，方便用户快速开始。

| 字段 | 类型 | 说明 |
|-----|------|------|
| `id` | BIGINT | 主键，自增 |
| `agent_id` | INT | 智能体 ID |
| `question` | TEXT | 预设问题 |
| `sort_order` | INT | 排序序号 |
| `is_active` | TINYINT | 是否激活（0/1） |
| `create_time` | TIMESTAMP | 创建时间 |
| `update_time` | TIMESTAMP | 更新时间 |

### 6.2 向量数据库

用于存储 Schema 的向量表示，支持语义检索。

**存储内容**:
- 表名、表注释的向量
- 字段名、字段注释的向量
- 业务知识的向量

**实现方式**:
- 开发环境：`SimpleVectorStore`（内存）
- 生产环境：`Milvus` 或 `AnalyticDB`

**Document 结构**:
```json
{
  "content": "表名: users, 描述: 用户表",
  "metadata": {
    "agentId": "1",
    "datasourceId": "1",
    "tableName": "users",
    "type": "table"
  }
}
```

---

## 7. API 接口设计

### 7.1 智能体管理 API

**Base URL**: `/api/agent`

| 方法 | 路径 | 说明 |
|-----|------|------|
| GET | `/list` | 获取智能体列表 |
| GET | `/{id}` | 获取智能体详情 |
| POST | `/` | 创建智能体 |
| PUT | `/{id}` | 更新智能体 |
| DELETE | `/{id}` | 删除智能体 |

**请求示例 - 创建智能体**:
```json
{
  "name": "销售数据分析助手",
  "description": "专注于销售数据分析",
  "category": "数据分析",
  "status": "draft",
  "humanReviewEnabled": 1,
  "tags": "销售,数据分析"
}
```

**响应示例**:
```json
{
  "id": 1,
  "name": "销售数据分析助手",
  "status": "draft",
  "createTime": "2025-11-06T10:00:00",
  "updateTime": "2025-11-06T10:00:00"
}
```

### 7.2 数据源管理 API

**Base URL**: `/api/datasource`

| 方法 | 路径 | 说明 |
|-----|------|------|
| GET | `/list` | 获取数据源列表 |
| POST | `/` | 创建数据源 |
| POST | `/test` | 测试数据源连接 |
| DELETE | `/{id}` | 删除数据源 |

**Base URL**: `/api/agent/{agentId}/datasources`

| 方法 | 路径 | 说明 |
|-----|------|------|
| GET | `/` | 获取智能体绑定的数据源 |
| POST | `/bind` | 绑定数据源到智能体 |
| POST | `/init` | 初始化数据源 Schema 到向量库 |
| POST | `/toggle` | 启用/禁用数据源 |
| DELETE | `/{datasourceId}` | 解绑数据源 |

**请求示例 - 初始化 Schema**:
```json
{
  "datasourceId": 1,
  "tables": ["users", "orders", "products"]
}
```

### 7.3 Graph 工作流 API

**Base URL**: `/api/graph`

| 方法 | 路径 | 说明 |
|-----|------|------|
| POST | `/stream` | 流式执行 Graph 工作流 |
| POST | `/feedback` | 提交人工反馈 |

**请求示例 - 流式执行**:
```json
{
  "agentId": "1",
  "threadId": "uuid-xxx",
  "query": "查询最近一周销售额最高的产品",
  "humanFeedback": false,
  "nl2sqlOnly": false,
  "plainReport": false
}
```

**响应格式 (SSE)**:
```
data: {"nodeName":"QueryRewriteNode","textType":"TEXT","text":"正在重写查询...","complete":false}

data: {"nodeName":"SqlExecuteNode","textType":"SQL","text":"SELECT * FROM products...","complete":false}

data: {"nodeName":"ReportGeneratorNode","textType":"MARK_DOWN","text":"# 分析报告\n...","complete":true}
```

**请求示例 - 人工反馈**:
```json
{
  "agentId": "1",
  "threadId": "uuid-xxx",
  "query": "",
  "humanFeedback": true,
  "humanFeedbackContent": "请修改 SQL，只查询最近 7 天的数据",
  "rejectedPlan": true
}
```

### 7.4 会话管理 API

**Base URL**: `/api`

| 方法 | 路径 | 说明 |
|-----|------|------|
| GET | `/agent/{id}/sessions` | 获取智能体的会话列表 |
| POST | `/sessions` | 创建新会话 |
| PUT | `/sessions/{id}/pin` | 置顶/取消置顶会话 |
| PUT | `/sessions/{id}/rename` | 重命名会话 |
| DELETE | `/sessions/{id}` | 删除会话 |
| GET | `/sessions/{id}/messages` | 获取会话消息 |
| DELETE | `/agent/{id}/sessions` | 清空智能体的所有会话 |

### 7.5 业务知识 API

**Base URL**: `/api/business-knowledge`

| 方法 | 路径 | 说明 |
|-----|------|------|
| GET | `/` | 获取业务知识列表 |
| GET | `/{id}` | 获取业务知识详情 |
| POST | `/` | 创建业务知识 |
| PUT | `/{id}` | 更新业务知识 |
| DELETE | `/{id}` | 删除业务知识 |

**请求示例**:
```json
{
  "businessTerm": "GMV",
  "description": "商品交易总额",
  "synonyms": "成交总额,交易额",
  "isRecall": true,
  "agentId": 1
}
```

### 7.6 文件上传 API

**Base URL**: `/api/upload`

| 方法 | 路径 | 说明 |
|-----|------|------|
| POST | `/avatar` | 上传头像 |

**请求**: `multipart/form-data`

**响应**:
```json
{
  "success": true,
  "message": "上传成功",
  "url": "/uploads/avatars/xxx.png"
}
```

---

## 8. 前端架构设计

### 8.1 页面结构

```
DataAgent Frontend
├── 智能体列表页 (AgentList.vue)
│   ├── 搜索和筛选
│   ├── 智能体卡片展示
│   └── 创建智能体按钮
├── 创建智能体页 (AgentCreate.vue)
│   ├── 基本信息配置
│   ├── 数据源绑定
│   ├── 业务知识配置
│   ├── 语义模型配置
│   └── 预设问题配置
├── 智能体详情页 (AgentDetail.vue)
│   ├── 基本信息展示和编辑
│   ├── 数据源管理
│   ├── 知识库管理
│   └── 配置管理
└── 对话交互页 (AgentRun.vue)
    ├── 会话列表（左侧）
    ├── 消息展示区（中间）
    ├── 输入框和预设问题
    └── 人工审核界面
```

### 8.2 核心组件

| 组件 | 功能 |
|-----|------|
| **AgentCard** | 智能体卡片展示 |
| **DataSourceSelector** | 数据源选择器 |
| **ChatMessage** | 消息气泡 |
| **CodeBlock** | 代码高亮显示 |
| **HumanReview** | 人工审核界面 |

### 8.3 状态管理

使用 Vue 3 Composition API 进行状态管理。

**核心状态**:
- `currentAgent` - 当前选中的智能体
- `sessions` - 会话列表
- `messages` - 当前会话的消息列表
- `isStreaming` - 是否正在流式输出
- `waitingForReview` - 是否等待人工审核

### 8.4 流式输出处理

使用 **Server-Sent Events (SSE)** 实现实时流式输出：

```typescript
const eventSource = graphApi.streamProcess(request);

eventSource.onmessage = (event) => {
  const data: GraphNodeResponse = JSON.parse(event.data);

  if (data.textType === 'SQL') {
    // 显示 SQL 代码
  } else if (data.textType === 'MARK_DOWN') {
    // 渲染 Markdown
  }

  if (data.complete) {
    eventSource.close();
  }
};
```

---

## 9. 安全性设计

### 9.1 数据源密码加密

- 使用 AES-256 加密存储数据源密码
- 密钥通过环境变量配置，不写入代码

### 9.2 SQL 注入防护

- 使用参数化查询
- 对用户输入进行严格校验
- LLM 生成的 SQL 进行语法检查

### 9.3 Python 代码执行隔离

**开发环境**:
- 使用 `local` 模式，直接执行（仅用于开发）

**生产环境**:
- 使用 `docker` 模式，在容器中执行
- 限制资源使用（CPU、内存、执行时间）
- 禁止网络访问和文件系统访问

### 9.4 API 访问控制

- 支持 JWT Token 认证（待实现）
- 基于角色的权限控制（RBAC）
- API 限流和防刷

---

## 10. 部署方案

### 10.1 开发环境

**依赖**:
- Java 17+
- Node.js 18+
- MySQL 8.0+

**启动步骤**:
```bash
# 1. 启动 MySQL
docker run -d -p 3307:3306 \
  -e MYSQL_ROOT_PASSWORD=root \
  -e MYSQL_DATABASE=data_agent \
  mysql:8.0

# 2. 配置环境变量
export AI_DASHSCOPE_API_KEY=your-api-key
export DATA_AGENT_DATASOURCE_URL=jdbc:mysql://127.0.0.1:3307/data_agent

# 3. 启动后端
cd spring-ai-alibaba-data-agent-management
mvn spring-boot:run

# 4. 启动前端
cd spring-ai-alibaba-data-agent-frontend
npm install
npm run dev
```

### 10.2 生产环境

**架构**:
```
┌─────────────┐
│   Nginx     │ (反向代理 + 静态资源)
└──────┬──────┘
       │
┌──────▼──────┐
│  Spring Boot│ (多实例 + 负载均衡)
└──────┬──────┘
       │
┌──────▼──────┬──────────────┬──────────────┐
│   MySQL     │  VectorStore │   DashScope  │
└─────────────┴──────────────┴──────────────┘
```

**Docker Compose 部署**:
```yaml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: data_agent
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"

  backend:
    build: ./spring-ai-alibaba-data-agent-management
    environment:
      AI_DASHSCOPE_API_KEY: ${DASHSCOPE_API_KEY}
      DATA_AGENT_DATASOURCE_URL: jdbc:mysql://mysql:3306/data_agent
    ports:
      - "8065:8065"
    depends_on:
      - mysql

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./dist:/usr/share/nginx/html
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mysql_data:
```

---

## 11. 扩展性设计

### 11.1 多模型支持

通过 Spring AI 的抽象接口，可以轻松切换不同的 AI 模型：

```java
@Bean
public ChatModel chatModel() {
    // 可替换为 OpenAI、Azure OpenAI、本地模型等
    return new DashScopeChatModel(dashScopeApi);
}

@Bean
public EmbeddingModel embeddingModel() {
    // 可替换为其他 Embedding 模型
    return new DashScopeEmbeddingModel(dashScopeApi);
}
```

### 11.2 自定义节点

添加新节点只需：
1. 实现 `NodeAction` 接口
2. 在 `DataAgentConfiguration` 中注册
3. 添加对应的 Dispatcher

```java
@Component
public class CustomNode implements NodeAction {
    @Override
    public Map<String, Object> apply(OverAllState state) {
        // 自定义逻辑
        return Map.of("custom_output", result);
    }
}
```

### 11.3 插件化架构

未来可支持：
- 自定义数据源连接器
- 自定义向量数据库
- 自定义代码执行器
- 自定义报告生成器

---

## 12. 性能优化

### 12.1 向量检索优化

- 使用 HNSW 索引加速检索
- 批量嵌入生成
- 缓存常用 Schema 向量

### 12.2 LLM 调用优化

- 使用流式输出减少等待时间
- 合理设置 Token 限制
- 缓存常见查询结果

### 12.3 数据库优化

- 合理设置索引
- 使用连接池（Druid）
- 读写分离（如需要）

---

## 13. 监控和日志

### 13.1 日志级别

```yaml
logging:
  level:
    com.alibaba.cloud.ai: DEBUG
    org.springframework.ai: INFO
```

### 13.2 关键指标

- Graph 执行时间
- 节点执行时间
- LLM 调用次数和耗时
- SQL 执行时间
- 错误率和重试次数

---

## 14. 未来规划

### 14.1 短期目标

- [ ] 完善权限管理系统
- [ ] 支持更多数据源类型（PostgreSQL、ClickHouse）
- [ ] 优化 Prompt 模板
- [ ] 增强错误处理和提示

### 14.2 中期目标

- [ ] 支持多轮对话上下文
- [ ] 数据可视化增强（图表生成）
- [ ] 支持导出分析报告（PDF、Excel）
- [ ] 移动端适配

### 14.3 长期目标

- [ ] 支持私有化部署
- [ ] 支持本地大模型
- [ ] 多租户 SaaS 版本
- [ ] 数据血缘分析

---

## 15. 总结

Spring AI Alibaba DataAgent 是一个功能完整、架构清晰的企业级 NL2SQL 解决方案。通过 Graph 工作流引擎的灵活编排，结合 Spring AI 的强大能力，实现了从自然语言到数据洞察的全流程自动化。

**核心优势**:
- ✅ **模块化设计**：易于维护和扩展
- ✅ **Graph 工作流**：灵活的任务编排
- ✅ **多租户支持**：支持多个智能体独立配置
- ✅ **人工审核**：关键步骤可人工介入
- ✅ **流式输出**：实时反馈，提升体验
- ✅ **知识增强**：业务知识库提升准确性

---

**文档版本**: v1.0
**最后更新**: 2025-11-06
**维护团队**: DataAgent 开发团队

